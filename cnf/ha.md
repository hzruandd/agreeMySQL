master-salve 这种方案最大的一个弊端就是切换步骤比较多,实现比较复杂。而且,在Master 出现 故障
crash 的那个时刻,我们的所有Slave 的复制进度并不一定完全一致,有可能有少量
的差异。这时候,选择哪一个 Slave 作为 Master 也是一个比较头疼的问题。所以这个方
案的可控性并不是特别的高。



MySQL Server 搭建成 Dual Master 环境,正常情况下,所有客户端的 Write 请求都写往
Master A,然后通过 Replication 将 Master A 复制到 Master B。一 旦 Master A
出现问题之后,所有的 Write 请求都转向 Master B。而在正常情况下,当 Master B
出现问题的时候,实际上不论是数据库还是客户端的请求,都不会受到实质性的 影响。
这里,可能有读者朋友会想到,当我们的Master A 出现问题的时候,应用如何做到自
动将请求转向到 Master B 呢?其实很简单,我们只需要通过相应的硬件设备如 F5 或者
Cluster 管理软件如 Heartbeat 来设置一个 VIP,正常情况下该 VIP 指向 Master A,而
一旦 Master A出现异常 crash 之后,则自动切换指向到Master B,前端所的应用都通过
这个 VIP 来访问 Master。这样,既解决了应用的IP 切换问题,还保证了在任何时刻应用
都只会见到一台 Master,避免了多点写入出现数据紊乱的可能。
这个方案最大的特点就是在 Master 出现故障之后的处理比较简单, 可控性比较大。而
弊端就是需要增加一台 MySQL 服务器,在成本方面投入更大。


#Dual Master 与级联复制结合解决在线 DDL 变更问题
当我们使用 Dual Master 加级联复制的组合架构的时候, 对于MySQL 的一个致命伤也
就是在线 DDL 变更来说, 也可以得到一定的解决。 如当我们需要给某个表tab
增加一个字 段,可以通过如下在上述架构中来实现:
1、在 Slave 集群中抽出一台暂时停止提供服务,然后对其进行变更,完成后再放回
集群继续提供服务;
2、 重复第一步的操作完成所有 Slave 的变更;
3、暂停 Master B 的复制,同时关闭当前 session 记录二进制日志的功能,对其进
行变更,完成后再启动复制;
4、 通过 VIP 切换,将应用所有对 Master A 的请求切换至 Master B; 5、关闭 Master A
当前 session 记录二进制日志的功能,然后进行变更; 6、 最后再将 VIP 从 Master B
切换回 Master A,至此,所有变更完成。
变更过程中有几点需要注意的:
1、 整个 Slave 集群需要能够承受在少一台 MySQL 的时候仍然能够支撑所有业务;
2、Slave 集群中增加或者减少一台 MySQL 的操作简单,可通过在线调整应用配置来
实现;
3、Dual Master 之间的 VIP 切换简单,且切换时间较短,因为这个切换过程会造成
短时间段内 应用无法访问 Master 数据库。
4、在变更 Master B 的时候,会出现短时间段内 Slave 集群数据的延时,所以如果
单台主机的变更时间较长的话,需要在业务量较低的凌晨进行变更。如果有必要,
甚至可能需要变更 Master B 之前将所有 Slave 切换为以 Master B 作为 Master。

当然,即使是这样,由于存在 Master A 与 Master B 之间的 VIP 切换,我们仍然会
出现短时间段内应用无法进行写入操作的情况。 所以说,
这种方案也仅仅能够在一定程上度 面解决 MySQL 在线 DDL
的问题。而且当集群数量较多,而且每个集群的节点也较多的况情
下,整个操作过程将会非常的复杂也很漫长。对于MySQL 在线 DDL 的问题,目前也确实还
没有一个非常完美的解决方案.

各种高可用方案的利弊比较
从前面各种高可用设计方案的介绍中读者们可能已经发现, 不管是哪一种方案, 都在存
自己独特的优势, 但也都或多或少的存在一些限制。 其实这也是很正常的,
毕竟任何事都物 不可能是完美的, 我们只能充分利用各自的优势来解决自己的问题,
而不是希望依赖某方种 案一劳永逸的解决所有问题。
这一节将针对上面的几种主要方案做一个利弊分析, 以供家大
选择过程中参考.


1、MySQL Replication
优势:部署简单,实施方便,维护也不复杂,是 MySQL 天生就支持的功能。且主备机
之间切换方便,可以通过第三方软件或者自行编写简单的脚本即可自动完成主备切换。
劣势:如果 Master 主机硬件故障且无法恢复,则可能造成部分未传送到 Slave 端的
数据丢失;
2、MySQL Cluster
优势: 可用性非常高, 性能非常好。 每一分数据至少在不同主机上面存在一份拷贝且,
冗余数据拷贝实时同步。
劣势:维护较为复杂,产品还比较新,存在部分bug,目前还不一定适用于比较核心的
线上系统。
3、DRBD 磁盘网络镜像方案
优势: 软件功能强大, 数据在底层快设备级别跨物理主机镜像, 且可根据性能和可性靠
要求配置不同级别的同步。IO 操作保持顺序,可满足数据库对数据一致性的苛刻要求。
劣势: 非分布式文件系统环境无法支持镜像数据同时可见, 性能和可靠性两者相盾互,矛
无法适用于性能和可靠性要求都比较苛刻的环境。维护成本高于MySQL Replication。
